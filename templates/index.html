<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>GPS Data â€“ FiltrovÃ¡nÃ­</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
    /* Overlay panel s filtry pÅ™Ã­mo nad mapou */
    .filter-overlay {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
      max-width: 320px;
      font-family: sans-serif;
      font-size: 14px;
    }
    .filter-overlay h2 {
      font-size: 16px;
      margin-top: 0;
      margin-bottom: 10px;
      text-align: center;
    }
    .filter-section {
      margin-bottom: 10px;
    }
    .filter-section > label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .checkbox-group label {
      display: inline-block;
      margin-right: 10px;
      margin-bottom: 5px;
    }
    /* ZarovnÃ¡nÃ­ checkboxÅ¯ pro mÄ›sÃ­ce do dvou sloupcÅ¯ */
    #monthCheckboxes {
      display: flex;
      flex-wrap: wrap;
    }
    #monthCheckboxes label {
      width: 45%;
      margin-bottom: 5px;
    }
    .radio-group label {
      display: inline-block;
      margin-right: 10px;
    }
    button {
      padding: 5px 10px;
      font-size: 14px;
      cursor: pointer;
    }
    /* Legenda teplotnÃ­ mapy */
    .heatmap-legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(255,255,255,0.9);
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 1000;
    }
    .heatmap-legend span {
      display: inline-block;
      width: 20px;
      height: 10px;
      margin-right: 5px;
    }
     /* ZmenÅ¡enÃ­ pÃ­sma u checkboxÅ¯ pro kategorie */
    #categoryCheckboxes label {
      font-size: 10px;
    }  
    #categoryCheckboxes {
      display: flex;
      flex-wrap: wrap;
    }
    #monthCheckboxes {
    display: flex;
    flex-wrap: wrap;
    }

    #monthCheckboxes label {
    flex: 1 1 30%; /* KaÅ¾dÃ½ label zabere cca 30% Å¡Ã­Å™ky, coÅ¾ umoÅ¾nÃ­ 3 sloupce */
    margin-bottom: 5px;
    }

    #categoryCheckboxes label {
      flex: 1 1 30%; /* KaÅ¾dÃ½ label bude mÃ­t pÅ™ibliÅ¾nÄ› 45% Å¡Ã­Å™ky, takÅ¾e se vytvoÅ™Ã­ dva sloupce */
      margin-bottom: 5px;
    }
    #helpTreeview {
    max-height: 150px;  /* pevnÃ¡ vÃ½Å¡ka, upravte dle potÅ™eby */
    overflow-y: auto;   /* vertikÃ¡lnÃ­ rolovÃ¡nÃ­ */
    }
  </style>
</head>
<body>
  <!-- Mapa -->
  <div id="map"></div>
  
  <!-- Overlay panel s filtry -->
  <div class="filter-overlay">
    <h2>VybranÃ© udÃ¡losti MÄ›stskÃ© policie</h2>
    <h2>MladÃ¡ Boleslav</h2>
    <!-- Volba reÅ¾imu zobrazenÃ­ -->
    <div class="filter-section" id="displayModeSection">
      <label>Zobrazit:</label>
      <div class="radio-group">
        <label><input type="radio" name="displayMode" value="body" checked> Body</label>
        <label><input type="radio" name="displayMode" value="heatmap"> TeplotnÃ­ mapa</label>
      </div>
    </div>
    <!-- Filtr pro rok -->
    <div class="filter-section" id="yearSection">
      <label>Rok</label>
      <div class="checkbox-group" id="yearCheckboxes">
        <!-- Dynamicky generovanÃ© checkboxy pro rok -->
      </div>
    </div>
    <!-- Filtr pro mÄ›sÃ­c -->
    <div class="filter-section" id="monthSection">
      <label>MÄ›sÃ­c</label>
      <div class="checkbox-group" id="monthCheckboxes">
        <label><input type="checkbox" value="01"> Leden</label>
        <label><input type="checkbox" value="02"> Ãšnor</label>
        <label><input type="checkbox" value="03"> BÅ™ezen</label>
        <label><input type="checkbox" value="04"> Duben</label>
        <label><input type="checkbox" value="05"> KvÄ›ten</label>
        <label><input type="checkbox" value="06"> ÄŒerven</label>
        <label><input type="checkbox" value="07"> ÄŒervenec</label>
        <label><input type="checkbox" value="08"> Srpen</label>
        <label><input type="checkbox" value="09"> ZÃ¡Å™Ã­</label>
        <label><input type="checkbox" value="10"> Å˜Ã­jen</label>
        <label><input type="checkbox" value="11"> Listopad</label>
        <label><input type="checkbox" value="12"> Prosinec</label>
      </div>
    </div>
    <!-- Filtr pro kategorii -->
    <div class="filter-section" id="categorySection">
      <label>Kategorie</label>
      <div class="checkbox-group" id="categoryCheckboxes">
        <!-- Dynamicky generovanÃ© checkboxy pro kategorii -->
      </div>
    </div>
    <div style="display: flex; justify-content: space-between; margin-top: 10px;"></div>

    <button id="showButton">Zobrazit</button>
    <button id="helpButton">NÃ¡povÄ›da</button>
    <!-- SkrytÃ½ Treeview pro nÃ¡povÄ›du -->
    <div id="helpTreeview" style="display: none; margin-top: 10px; border: 1px solid #ccc; padding: 5px;">
      <strong>NÃ¡povÄ›da</strong>
      <ul>
        <br>Zobrazit jdou jen vybranÃ© udÃ¡losti. Seznam nepÅ™edstavuje kompletnÃ­ Äinnost mÄ›stskÃ© policie.</br>
        <br><b>UPOZORNÄšNÃ</b>poklud zobrazÃ­te body a nevyberete Å¾Ã¡dnoukategorii naÄÃ­tÃ¡nÃ­ dat bude pomalÃ© protoÅ¾e se  musÃ­ zobrazit pes 10.000 udÃ¡lostÃ­. </br>
        <br></br>
        <P><b>KATEGORIE</b></P>
        <li><b>ParkovÃ¡nÃ­</b>ğŸ…¿ï¸-PÅ™estupky ZastavenÃ­ a stÃ¡nÃ­ </li>
        <li><b>NoÄnÃ­ klid</b>ğŸ”•- PÅ™estupky poruÅ¡enÃ­ NoÄnÃ­ho klidu </li> 
        <li><b>Chodec</b>ğŸš¶-PÅ™estupky ChodcÅ¯ </li> 
        <li><b>>KrÃ¡deÅ¾</b>ğŸ’°-PÅ™estupky DdrobnÃ¡ krÃ¡deÅ¾ </li> 
        <li><b>TrestnÃ½ Äin</b>ğŸš¨-PodezÅ™enÃ­ z trestnÃ©ho Äinu </li> 
        <li><b>KO</b>ğŸ”-Kontrola osoby </li> 
        <li><b>PrvnÃ­ pomoc</b>ğŸš‘-PoskytnutÃ­ prvnÃ­ pomoci </li>
        <li><b>OstatnÃ­ z.</b>â“-OstatnÃ­ zÃ¡vady </li>
        <li><b>ZeleÅˆ</b>ğŸŒ³-ZÃ¡vada na zeleni </li> 
        <li><b>OstatnÃ­ OZV</b>ğŸ›ï¸-OstatnÃ­ pÅ™estupky OZV (ObecnÄ› zÃ¡vaznÃ© vyhlÃ¡Å¡ky naÅ™. Å¾ebrÃ¡nÃ­, podomnÃ­ prodej atd.) </li> 
        <li><b>OstatnÃ­</b>â—-OstatnÃ­ pÅ™estupky (napÅ™.:ObÄanskÃ© souÅ¾itÃ­,pytlÃ¡ctvÃ­ atd.) </li> 
        <li><b>Alkohol</b>ğŸº- PÅ™estupky pitÃ¡ lakoholu na veÅ™ejnosti </li>
        <li><b>Cyklista</b>ğŸš´- PÅ™estupky cyklistÅ¯ a kolobÄ›Å¾ek</li> 
        <li><b>KadavÃ©r</b>ğŸ’€- SbÄ›r kadaverÅ¯ (mrtvÃ¡ zvÃ­Å™ata)</li> 
        <li><b>ÄŒistota</b>ğŸ—‘ï¸- ZÃ¡vada NepoÅ™Ã¡dek </li>
        <li><b>OsvÄ›tlenÃ­</b>ğŸ’¡- ZÃ¡vada na OsvÄ›tlenÃ­ </li>
        <li><b>VeÅ™. poÅ™Ã¡dek</b>ğŸ‘®- PÅ™estupky VeÅ™ejnÃ©ho poÅ™Ã¡dku naÅ™. zÃ¡bor, neuposlechnutÃ­ vÃ½zvy, zneÄiÅ¡tÄ›nÃ­ v.p., atd. </li>
        <li><b>OstatnÃ­ DP</b>ğŸ‘®- PÅ™estupky VeÅ™ejnÃ©ho poÅ™Ã¡dku naÅ™. zÃ¡bor, neuposlechnutÃ­ vÃ½zvy, zneÄiÅ¡tÄ›nÃ­ v.p., atd. </li>
        <li><b>KouÅ™enÃ­</b>ğŸš­- PÅ™estupky zÃ¡kaz kouÅ¾enÃ­ na mÃ­stÄ›chzakÃ¡zanÃ½ch napÅ™. autobusovÃ© zastÃ¡vky</li>
        <li><b>Odchyt</b>ğŸ•- Odchyt zvÃ­Å™ete, nejÄastÄ›ji pas, ale i had atd..</li>
        <li><b>Pomoc</b>ğŸ¤- Pomoc obÄanÅ¯m napÅ™. zabouchnutÃ© dveÅ™e, nastartovÃ¡nÃ­ vozu atd.</li>
        <li><b>ZnaÄenÃ­</b>ğŸš¸- ZÃ¡vada na dopravnÃ­m zanÄenÃ­. napÅ™.vylomenÃ©, zakrytÃ¡, chybÄ›jÃ­cÃ­ dopravnÃ­ znaÄka</li>
        <li><b>VybavenÃ­</b>ğŸª‘- ZÃ¡vada na obÄanskÃ©m vybavenÃ­. napÅ™.poÅ¡klozenÃ¡, laviÄka, odpadkovÃ½ koÅ¡ atd.</li>

      </ul>
    </div>
  </div>
  
  <!-- Legenda teplotnÃ­ mapy -->
  <div class="heatmap-legend" id="heatmapLegend" style="display:none;"></div>
  
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script>
    // Inicializace mapy, centrum MladÃ¡ Boleslav
    var map = L.map('map').setView([50.4147, 14.9272], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data Â© OpenStreetMap contributors'
    }).addTo(map);
    
    // Vrstvy pro body a heatmapu
    var markersLayer = L.layerGroup().addTo(map);
    var heatLayer = null;
    
    // GlobÃ¡lnÃ­ promÄ›nnÃ¡ pro aktuÃ¡lnÃ­ heatData
    var currentHeatData = [];
    
    // Funkce pro naÄtenÃ­ filtrÅ¯ a vytvoÅ™enÃ­ checkboxÅ¯ pro roky a kategorie
    function loadFilters() {
      fetch('/api/filters')
        .then(response => response.json())
        .then(data => {
          var years = new Set();
          var categories = new Map();
          data.forEach(item => {
            years.add(item.year);
            if (!categories.has(item.kategorie)) {
              categories.set(item.kategorie, item.symbol);
            }
          });
           // DefaultnÄ› vybranÃ© kategorie (pÅ™esnÃ© nÃ¡zvy, jak jsou vraceny z API) mÅ¯Å¾e jich tam bÃ½t vÃ­c
          var defaultCategories = ["PrvnÃ­ pomoc"];

          var yearContainer = document.getElementById("yearCheckboxes");
          years.forEach(year => {
            var label = document.createElement("label");
            var checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.value = year;
            // MÅ¯Å¾ete pÅ™Ã­padnÄ› nastavit defaultnÃ­ rok, napÅ™. aktuÃ¡lnÃ­ rok:
            // if (year === "2023") { checkbox.checked = true; }
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(" " + year));
            yearContainer.appendChild(label);
          });
          // Definice defaultnÄ› vybranÃ½ch kategoriÃ­ (pouÅ¾ijte pÅ™esnÃ© nÃ¡zvy, jak jsou vraceny z API)
          var defaultCategories = ["PrvnÃ­ pomoc"];

          var categoryContainer = document.getElementById("categoryCheckboxes");
          categories.forEach((symbol, cat) => {
            var label = document.createElement("label");
            var checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.value = cat;
            checkbox.setAttribute("data-symbol", symbol);
            // Pokud je kategorie mezi defaultnÄ› vybranÃ½mi, nastavÃ­me checkbox jako zaÅ¡krtnutÃ½
            if (defaultCategories.includes(cat)) {
              checkbox.checked = true;
            }
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(" " + cat + " " + symbol));
            categoryContainer.appendChild(label);
          });
          // Po naÄtenÃ­ filtrÅ¯ automaticky zavolÃ¡me loadData, aby se zobrazily defaultnÃ­ poloÅ¾ky
          loadData();
        });
    }
    
    // Funkce aktualizuje legendu teplotnÃ­ mapy podle aktuÃ¡lnÃ­ch dat a zornÃ©ho pole
    function updateLegend() {
      if (!heatLayer || currentHeatData.length === 0) return;
      var bounds = map.getBounds();
      var visibleCount = currentHeatData.filter(function(pt) {
        return bounds.contains(L.latLng(pt[0], pt[1]));
      }).length;
      document.getElementById("heatmapLegend").innerHTML =
        `<strong>ViditelnÃ© pÅ™Ã­pady</strong><br>${visibleCount} (Celkem: ${currentHeatData.length})`;
    }
    
    // Funkce naÄte data podle vybranÃ½ch filtrÅ¯
    function loadData() {
      var displayMode = document.querySelector("input[name='displayMode']:checked").value;
      
      var selectedYears = [];
      document.querySelectorAll("#yearCheckboxes input[type='checkbox']:checked")
        .forEach(cb => selectedYears.push(cb.value));
      
      var selectedMonths = [];
      document.querySelectorAll("#monthCheckboxes input[type='checkbox']:checked")
        .forEach(cb => selectedMonths.push(cb.value));
      
      var selectedCategories = [];
      document.querySelectorAll("#categoryCheckboxes input[type='checkbox']:checked")
        .forEach(cb => selectedCategories.push(cb.value));
      
      var queryParams = [];
      if (selectedYears.length > 0) {
        queryParams.push("year=" + encodeURIComponent(selectedYears.join(",")));
      }
      if (selectedMonths.length > 0) {
        queryParams.push("month=" + encodeURIComponent(selectedMonths.join(",")));
      }
      if (selectedCategories.length > 0) {
        queryParams.push("kategorie=" + encodeURIComponent(selectedCategories.join(",")));
      }
      var queryString = queryParams.join("&");
      
      fetch("/api/data?" + queryString)
        .then(response => response.json())
        .then(data => {
          // VyÄiÅ¡tÄ›nÃ­ vrstev
          markersLayer.clearLayers();
          if (heatLayer) {
            map.removeLayer(heatLayer);
            heatLayer = null;
          }
          
          // ReÅ¾im "Body"
          if (displayMode === "body") {
            document.getElementById("heatmapLegend").style.display = "none";
            data.forEach(item => {
              var icon = L.divIcon({
                html: `<span style="font-size:16px;">${item.symbol}</span>`,
                className: ""
              });
              var marker = L.marker([item.sirka, item.delka], {icon: icon})
                .bindPopup(`Datum: ${item.datum}<br>Kategorie: ${item.kategorie}`);
              markersLayer.addLayer(marker);
            });
          }
          // ReÅ¾im "TeplotnÃ­ mapa"
          else if (displayMode === "heatmap") {
            if (selectedCategories.length !== 1) {
              alert("Pro teplotnÃ­ mapu vyberte prosÃ­m prÃ¡vÄ› 1 kategorii.");
              return;
            }
            document.getElementById("heatmapLegend").style.display = "block";
            
            // VytvoÅ™Ã­me heatData: kaÅ¾dÃ½ zÃ¡znam mÃ¡ intenzitu 1
            currentHeatData = data.map(item => [item.sirka, item.delka, 1]);
            var totalCount = currentHeatData.length;
            
            heatLayer = L.heatLayer(currentHeatData, {
              radius: 25,
              blur: 15,
              maxZoom: 17,
              gradient: {0.0: 'green', 1.0: 'red'}
            }).addTo(map);
            
            // Aktualizujeme legendu
            updateLegend();
          }
        });
    }
    
    // Aktualizace legendy pÅ™i kaÅ¾dÃ© zmÄ›nÄ› zornÃ©ho pole mapy (zoom/pan)
    map.on("moveend", function() {
      updateLegend();
    });
    
    document.getElementById("showButton").addEventListener("click", loadData);
    
    // Inicializace filtrÅ¯ pÅ™i naÄtenÃ­ strÃ¡nky
    loadFilters();

    // PÅ™idÃ¡nÃ­ posluchaÄe udÃ¡losti pro tlaÄÃ­tko NÃ¡povÄ›da
    document.getElementById("helpButton").addEventListener("click", function() {
        var helpDiv = document.getElementById("helpTreeview");
          if (helpDiv.style.display === "none") {
                helpDiv.style.display = "block";
          } else {
            helpDiv.style.display = "none";
          }
});

  </script>
</body>
</html>
